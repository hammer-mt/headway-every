<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Therapist Data Dashboard | Headway</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: #1a1a1a;
      background: #f7f7f5;
      line-height: 1.5;
    }
    a { color: inherit; text-decoration: none; }
    button { cursor: pointer; font-family: inherit; }

    :root {
      --green-dark: #166534;
      --green-mid: #16a34a;
      --green-light: #dcfce7;
      --cream: #fef9f0;
      --bg-light: #f7f7f5;
      --text-primary: #1a1a1a;
      --text-secondary: #6b7280;
      --border-color: #e5e7eb;
    }

    .font-serif { font-family: Georgia, 'Times New Roman', Times, serif; }

    /* ===== NAVBAR ===== */
    .navbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 40px;
      background: #fff;
      border-bottom: 1px solid var(--border-color);
    }
    .navbar-logo {
      font-size: 24px;
      font-weight: 700;
      color: var(--green-dark);
    }
    .navbar-links { display: flex; gap: 24px; align-items: center; }
    .navbar-links a {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      transition: color 0.15s;
    }
    .navbar-links a:hover { color: var(--green-dark); }
    .navbar-links a.active { color: var(--green-dark); font-weight: 600; }

    /* ===== HEADER ===== */
    .dashboard-header {
      background: linear-gradient(135deg, var(--green-dark), #1e7a45);
      color: #fff;
      padding: 48px 40px 40px;
    }
    .dashboard-header h1 {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .dashboard-header p {
      font-size: 16px;
      opacity: 0.85;
    }

    /* ===== LAYOUT ===== */
    .dashboard-body {
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px 40px 64px;
    }

    /* ===== STAT CARDS ===== */
    .stat-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 36px;
    }
    .stat-card {
      background: #fff;
      border-radius: 12px;
      padding: 24px;
      border: 1px solid var(--border-color);
    }
    .stat-card .stat-label {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }
    .stat-card .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: var(--green-dark);
    }
    .stat-card .stat-detail {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    /* ===== CHART PANELS ===== */
    .chart-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 36px;
    }
    .chart-panel {
      background: #fff;
      border-radius: 12px;
      padding: 28px;
      border: 1px solid var(--border-color);
    }
    .chart-panel.full-width {
      grid-column: 1 / -1;
    }
    .chart-panel h2 {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 20px;
      color: var(--text-primary);
    }

    /* ===== BAR CHART ===== */
    .bar-chart { display: flex; flex-direction: column; gap: 10px; }
    .bar-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .bar-label {
      flex: 0 0 180px;
      font-size: 13px;
      color: var(--text-primary);
      text-align: right;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .bar-track {
      flex: 1;
      height: 28px;
      background: #f3f4f6;
      border-radius: 6px;
      overflow: hidden;
      position: relative;
    }
    .bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--green-mid), var(--green-dark));
      border-radius: 6px;
      transition: width 0.6s ease;
      min-width: 2px;
    }
    .bar-count {
      flex: 0 0 40px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
    }

    /* ===== DONUT CHART (CSS) ===== */
    .donut-container {
      display: flex;
      align-items: center;
      gap: 32px;
    }
    .donut-svg {
      width: 180px;
      height: 180px;
      flex-shrink: 0;
    }
    .donut-legend { display: flex; flex-direction: column; gap: 8px; }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }
    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .legend-label { color: var(--text-primary); }
    .legend-count { color: var(--text-secondary); font-weight: 600; margin-left: auto; padding-left: 12px; }

    /* ===== HISTOGRAM ===== */
    .histogram {
      display: flex;
      align-items: flex-end;
      gap: 4px;
      height: 160px;
      padding-top: 8px;
    }
    .hist-bar-group {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100%;
      justify-content: flex-end;
    }
    .hist-bar {
      width: 100%;
      max-width: 48px;
      background: linear-gradient(180deg, var(--green-mid), var(--green-dark));
      border-radius: 4px 4px 0 0;
      transition: height 0.6s ease;
      position: relative;
    }
    .hist-bar:hover { opacity: 0.85; }
    .hist-bar .hist-tooltip {
      display: none;
      position: absolute;
      top: -28px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: #fff;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 4px;
      white-space: nowrap;
    }
    .hist-bar:hover .hist-tooltip { display: block; }
    .hist-label {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 6px;
      text-align: center;
    }

    /* ===== HEATMAP ===== */
    .heatmap-grid {
      display: grid;
      gap: 3px;
    }
    .heatmap-cell {
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 600;
      color: #fff;
      min-height: 36px;
      cursor: default;
      position: relative;
    }
    .heatmap-cell.empty { background: #f3f4f6; color: #ccc; }
    .heatmap-header {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      text-align: center;
      padding: 4px 0;
    }

    /* ===== DATA TABLE ===== */
    .table-controls {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      align-items: center;
    }
    .table-controls input, .table-controls select {
      padding: 8px 14px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 14px;
      background: #fff;
    }
    .table-controls input { flex: 1; min-width: 200px; }
    .table-controls select { min-width: 160px; }

    .data-table-wrap {
      overflow-x: auto;
      border-radius: 10px;
      border: 1px solid var(--border-color);
    }
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .data-table th {
      text-align: left;
      padding: 12px 16px;
      background: var(--green-dark);
      color: #fff;
      font-weight: 600;
      white-space: nowrap;
      cursor: pointer;
      user-select: none;
    }
    .data-table th:hover { background: #1a7a3f; }
    .data-table th .sort-arrow { margin-left: 4px; opacity: 0.5; }
    .data-table th.sorted .sort-arrow { opacity: 1; }
    .data-table td {
      padding: 10px 16px;
      border-bottom: 1px solid #f0f0f0;
      white-space: nowrap;
    }
    .data-table tbody tr:hover { background: var(--green-light); }
    .data-table tbody tr:nth-child(even) { background: #fafafa; }
    .data-table tbody tr:nth-child(even):hover { background: var(--green-light); }

    .tag {
      display: inline-block;
      background: var(--green-light);
      color: var(--green-dark);
      font-size: 11px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 20px;
      margin: 1px 2px;
    }
    .tag.insurance { background: #e0e7ff; color: #3730a3; }
    .table-link {
      color: var(--green-mid);
      font-weight: 600;
    }
    .table-link:hover { text-decoration: underline; }
    .table-count {
      text-align: center;
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 12px;
    }

    /* ===== TABS ===== */
    .tab-bar {
      display: flex;
      gap: 0;
      border-bottom: 2px solid var(--border-color);
      margin-bottom: 24px;
    }
    .tab-btn {
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      color: var(--text-secondary);
      transition: all 0.15s;
    }
    .tab-btn:hover { color: var(--green-dark); }
    .tab-btn.active {
      color: var(--green-dark);
      border-bottom-color: var(--green-dark);
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 900px) {
      .chart-grid { grid-template-columns: 1fr; }
      .dashboard-header { padding: 32px 20px; }
      .dashboard-body { padding: 20px; }
      .navbar { padding: 12px 20px; }
      .bar-label { flex: 0 0 120px; }
      .donut-container { flex-direction: column; }
    }
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar">
  <a href="index.html" class="navbar-logo">headway</a>
  <div class="navbar-links">
    <a href="index.html">Directory</a>
    <a href="dashboard.html" class="active">Dashboard</a>
  </div>
</nav>

<!-- Header -->
<div class="dashboard-header">
  <h1>Therapist Data Dashboard</h1>
  <p>Explore the provider network — specialties, coverage, experience, and more.</p>
</div>

<!-- Dashboard Body -->
<div class="dashboard-body">

  <!-- Stat Cards -->
  <div class="stat-row" id="stat-row"></div>

  <!-- Tabs -->
  <div class="tab-bar">
    <button class="tab-btn active" data-tab="overview">Overview</button>
    <button class="tab-btn" data-tab="specialties">Specialties</button>
    <button class="tab-btn" data-tab="insurance">Insurance</button>
    <button class="tab-btn" data-tab="demographics">Demographics</button>
    <button class="tab-btn" data-tab="table">Data Table</button>
  </div>

  <!-- OVERVIEW TAB -->
  <div class="tab-content active" id="tab-overview">
    <div class="chart-grid">
      <div class="chart-panel">
        <h2>License Types</h2>
        <div id="chart-license"></div>
      </div>
      <div class="chart-panel">
        <h2>Virtual vs In-Person</h2>
        <div id="chart-virtual"></div>
      </div>
      <div class="chart-panel">
        <h2>Years of Experience</h2>
        <div id="chart-experience"></div>
      </div>
      <div class="chart-panel">
        <h2>States Licensed In</h2>
        <div id="chart-states"></div>
      </div>
    </div>
  </div>

  <!-- SPECIALTIES TAB -->
  <div class="tab-content" id="tab-specialties">
    <div class="chart-grid">
      <div class="chart-panel">
        <h2>Top Specialties</h2>
        <div id="chart-specialties"></div>
      </div>
      <div class="chart-panel">
        <h2>Therapy Methods</h2>
        <div id="chart-methods"></div>
      </div>
      <div class="chart-panel">
        <h2>Care Types</h2>
        <div id="chart-care"></div>
      </div>
      <div class="chart-panel">
        <h2>Therapist Style</h2>
        <div id="chart-style"></div>
      </div>
    </div>
  </div>

  <!-- INSURANCE TAB -->
  <div class="tab-content" id="tab-insurance">
    <div class="chart-grid">
      <div class="chart-panel full-width">
        <h2>Insurance Accepted</h2>
        <div id="chart-insurance"></div>
      </div>
    </div>
  </div>

  <!-- DEMOGRAPHICS TAB -->
  <div class="tab-content" id="tab-demographics">
    <div class="chart-grid">
      <div class="chart-panel">
        <h2>Languages Spoken</h2>
        <div id="chart-languages"></div>
      </div>
      <div class="chart-panel">
        <h2>Ages Served</h2>
        <div id="chart-ages"></div>
      </div>
      <div class="chart-panel">
        <h2>Free Consultation Offered</h2>
        <div id="chart-consult"></div>
      </div>
      <div class="chart-panel">
        <h2>Pronouns</h2>
        <div id="chart-pronouns"></div>
      </div>
    </div>
  </div>

  <!-- DATA TABLE TAB -->
  <div class="tab-content" id="tab-table">
    <div class="chart-panel full-width">
      <h2>All Therapists</h2>
      <div class="table-controls">
        <input type="text" id="table-search" placeholder="Search by name, specialty, location...">
        <select id="table-filter-license">
          <option value="">All License Types</option>
        </select>
        <select id="table-filter-state">
          <option value="">All States</option>
        </select>
      </div>
      <div class="data-table-wrap">
        <table class="data-table" id="data-table">
          <thead>
            <tr>
              <th data-sort="name">Name <span class="sort-arrow">&#x25B2;</span></th>
              <th data-sort="licenseType">License <span class="sort-arrow">&#x25B2;</span></th>
              <th data-sort="location">Location <span class="sort-arrow">&#x25B2;</span></th>
              <th data-sort="yearsOfExperience">Experience <span class="sort-arrow">&#x25B2;</span></th>
              <th data-sort="specialtiesCount">Specialties <span class="sort-arrow">&#x25B2;</span></th>
              <th data-sort="insuranceCount">Insurance <span class="sort-arrow">&#x25B2;</span></th>
              <th data-sort="virtual">Virtual <span class="sort-arrow">&#x25B2;</span></th>
              <th data-sort="freeConsultation">Free Consult <span class="sort-arrow">&#x25B2;</span></th>
            </tr>
          </thead>
          <tbody id="table-body"></tbody>
        </table>
      </div>
      <div class="table-count" id="table-count"></div>
    </div>
  </div>

</div>

<script src="therapists.js"></script>
<script>
(function() {
  const data = THERAPISTS_DATA;

  // ===== HELPERS =====
  function countField(field, flatten) {
    const counts = {};
    data.forEach(t => {
      let vals = t[field];
      if (!vals) return;
      if (!Array.isArray(vals)) vals = [vals];
      vals.forEach(v => { counts[v] = (counts[v] || 0) + 1; });
    });
    return Object.entries(counts).sort((a, b) => b[1] - a[1]);
  }

  function shortLicense(lic) {
    if (!lic) return 'Unknown';
    const m = lic.match(/^([A-Z\-]+)/);
    return m ? m[1] : lic.slice(0, 15);
  }

  // ===== STAT CARDS =====
  const statRow = document.getElementById('stat-row');
  const totalTherapists = data.length;
  const avgExp = (data.reduce((s, t) => s + (t.yearsOfExperience || 0), 0) / totalTherapists).toFixed(1);
  const allSpecialties = new Set();
  data.forEach(t => {
    (t.specialties || []).forEach(s => allSpecialties.add(s));
    (t.moreSpecialties || []).forEach(s => allSpecialties.add(s));
  });
  const allInsurance = new Set();
  data.forEach(t => (t.insurance || []).forEach(i => allInsurance.add(i)));
  const virtualCount = data.filter(t => t.virtual).length;
  const states = new Set(data.map(t => t.licensedIn).filter(Boolean));

  const stats = [
    { label: 'Total Providers', value: totalTherapists, detail: 'across ' + states.size + ' states' },
    { label: 'Avg. Experience', value: avgExp + 'yr', detail: 'years of practice' },
    { label: 'Unique Specialties', value: allSpecialties.size, detail: 'treatment areas' },
    { label: 'Insurance Plans', value: allInsurance.size, detail: 'accepted plans' },
    { label: 'Virtual Available', value: Math.round(virtualCount / totalTherapists * 100) + '%', detail: virtualCount + ' of ' + totalTherapists },
  ];
  stats.forEach(s => {
    const card = document.createElement('div');
    card.className = 'stat-card';
    card.innerHTML = '<div class="stat-label">' + s.label + '</div><div class="stat-value">' + s.value + '</div><div class="stat-detail">' + s.detail + '</div>';
    statRow.appendChild(card);
  });

  // ===== BAR CHART RENDERER =====
  function renderBarChart(containerId, entries, limit) {
    const container = document.getElementById(containerId);
    const items = limit ? entries.slice(0, limit) : entries;
    const max = items.length ? items[0][1] : 1;
    const chart = document.createElement('div');
    chart.className = 'bar-chart';
    items.forEach(([label, count]) => {
      const pct = (count / max * 100).toFixed(1);
      chart.innerHTML += '<div class="bar-row"><div class="bar-label" title="' + label + '">' + label + '</div><div class="bar-track"><div class="bar-fill" style="width:' + pct + '%"></div></div><div class="bar-count">' + count + '</div></div>';
    });
    container.appendChild(chart);
  }

  // ===== DONUT CHART RENDERER =====
  const DONUT_COLORS = ['#166534','#16a34a','#4ade80','#86efac','#bbf7d0','#6366f1','#818cf8','#c4b5fd','#f59e0b','#fb923c','#f87171','#a78bfa'];
  function renderDonut(containerId, entries) {
    const container = document.getElementById(containerId);
    const total = entries.reduce((s, e) => s + e[1], 0);
    const wrap = document.createElement('div');
    wrap.className = 'donut-container';

    // SVG donut
    let cumAngle = 0;
    const R = 70, cx = 90, cy = 90;
    let paths = '';
    entries.forEach(([label, count], i) => {
      const frac = count / total;
      const angle = frac * 360;
      const startAngle = cumAngle;
      const endAngle = cumAngle + angle;
      const largeArc = angle > 180 ? 1 : 0;
      const startRad = (startAngle - 90) * Math.PI / 180;
      const endRad = (endAngle - 90) * Math.PI / 180;
      const x1 = cx + R * Math.cos(startRad);
      const y1 = cy + R * Math.sin(startRad);
      const x2 = cx + R * Math.cos(endRad);
      const y2 = cy + R * Math.sin(endRad);
      const color = DONUT_COLORS[i % DONUT_COLORS.length];
      if (angle >= 359.9) {
        paths += '<circle cx="' + cx + '" cy="' + cy + '" r="' + R + '" fill="' + color + '" />';
      } else {
        paths += '<path d="M' + cx + ',' + cy + ' L' + x1 + ',' + y1 + ' A' + R + ',' + R + ' 0 ' + largeArc + ',1 ' + x2 + ',' + y2 + ' Z" fill="' + color + '"/>';
      }
      cumAngle += angle;
    });
    // Inner circle for donut hole
    paths += '<circle cx="' + cx + '" cy="' + cy + '" r="40" fill="#fff"/>';
    paths += '<text x="' + cx + '" y="' + (cy + 5) + '" text-anchor="middle" font-size="18" font-weight="700" fill="#166534">' + total + '</text>';

    const svg = '<svg class="donut-svg" viewBox="0 0 180 180">' + paths + '</svg>';

    // Legend
    let legend = '<div class="donut-legend">';
    entries.forEach(([label, count], i) => {
      const color = DONUT_COLORS[i % DONUT_COLORS.length];
      legend += '<div class="legend-item"><span class="legend-dot" style="background:' + color + '"></span><span class="legend-label">' + label + '</span><span class="legend-count">' + count + '</span></div>';
    });
    legend += '</div>';

    wrap.innerHTML = svg + legend;
    container.appendChild(wrap);
  }

  // ===== HISTOGRAM RENDERER =====
  function renderHistogram(containerId, buckets) {
    const container = document.getElementById(containerId);
    const max = Math.max(...buckets.map(b => b.count));
    const hist = document.createElement('div');
    hist.className = 'histogram';
    buckets.forEach(b => {
      const h = max > 0 ? (b.count / max * 140) : 0;
      hist.innerHTML += '<div class="hist-bar-group"><div class="hist-bar" style="height:' + h + 'px"><span class="hist-tooltip">' + b.count + ' therapists</span></div><div class="hist-label">' + b.label + '</div></div>';
    });
    container.appendChild(hist);
  }

  // ===== OVERVIEW TAB =====
  // License types
  const licenseEntries = countField('licenseType');
  const shortLicenseMap = {};
  licenseEntries.forEach(([lic, count]) => {
    const short = shortLicense(lic);
    shortLicenseMap[short] = (shortLicenseMap[short] || 0) + count;
  });
  renderBarChart('chart-license', Object.entries(shortLicenseMap).sort((a,b) => b[1]-a[1]), 10);

  // Virtual vs in-person
  const inPerson = totalTherapists - virtualCount;
  renderDonut('chart-virtual', [['Virtual', virtualCount], ['In-Person', inPerson]]);

  // Experience histogram
  const expBuckets = [
    { label: '0-2', min: 0, max: 2, count: 0 },
    { label: '3-5', min: 3, max: 5, count: 0 },
    { label: '6-10', min: 6, max: 10, count: 0 },
    { label: '11-15', min: 11, max: 15, count: 0 },
    { label: '16-20', min: 16, max: 20, count: 0 },
    { label: '21-30', min: 21, max: 30, count: 0 },
    { label: '31+', min: 31, max: 999, count: 0 },
  ];
  data.forEach(t => {
    const y = t.yearsOfExperience || 0;
    for (const b of expBuckets) { if (y >= b.min && y <= b.max) { b.count++; break; } }
  });
  renderHistogram('chart-experience', expBuckets);

  // States
  const stateEntries = countField('licensedIn');
  renderBarChart('chart-states', stateEntries, 15);

  // ===== SPECIALTIES TAB =====
  // Combine specialties + moreSpecialties
  const specCounts = {};
  data.forEach(t => {
    (t.specialties || []).forEach(s => { specCounts[s] = (specCounts[s] || 0) + 1; });
    (t.moreSpecialties || []).forEach(s => { specCounts[s] = (specCounts[s] || 0) + 1; });
  });
  renderBarChart('chart-specialties', Object.entries(specCounts).sort((a,b) => b[1]-a[1]), 15);

  // Therapy methods
  renderBarChart('chart-methods', countField('therapyMethods'), 12);

  // Care types
  renderDonut('chart-care', countField('careTypes'));

  // Style
  renderBarChart('chart-style', countField('style'), 12);

  // ===== INSURANCE TAB =====
  renderBarChart('chart-insurance', countField('insurance'), 25);

  // ===== DEMOGRAPHICS TAB =====
  renderBarChart('chart-languages', countField('languages'), 10);
  renderDonut('chart-ages', countField('agesServed'));
  const freeYes = data.filter(t => t.freeConsultation).length;
  const freeNo = totalTherapists - freeYes;
  renderDonut('chart-consult', [['Yes', freeYes], ['No', freeNo]]);
  renderBarChart('chart-pronouns', countField('pronouns'), 8);

  // ===== DATA TABLE =====
  // Populate filter dropdowns
  const licenseSelect = document.getElementById('table-filter-license');
  Object.entries(shortLicenseMap).sort((a,b) => b[1]-a[1]).forEach(([lic]) => {
    const opt = document.createElement('option');
    opt.value = lic;
    opt.textContent = lic;
    licenseSelect.appendChild(opt);
  });
  const stateSelect = document.getElementById('table-filter-state');
  stateEntries.forEach(([st]) => {
    const opt = document.createElement('option');
    opt.value = st;
    opt.textContent = st;
    stateSelect.appendChild(opt);
  });

  let sortCol = 'name', sortDir = 1;

  function renderTable() {
    const search = document.getElementById('table-search').value.toLowerCase();
    const licFilter = licenseSelect.value;
    const stFilter = stateSelect.value;

    let filtered = data.filter(t => {
      if (licFilter && shortLicense(t.licenseType) !== licFilter) return false;
      if (stFilter && t.licensedIn !== stFilter) return false;
      if (search) {
        const haystack = [t.name, t.licenseType, t.location, t.licensedIn, ...(t.specialties || []), ...(t.moreSpecialties || [])].join(' ').toLowerCase();
        if (!haystack.includes(search)) return false;
      }
      return true;
    });

    // Sort
    filtered.sort((a, b) => {
      let va, vb;
      if (sortCol === 'specialtiesCount') {
        va = (a.specialties || []).length + (a.moreSpecialties || []).length;
        vb = (b.specialties || []).length + (b.moreSpecialties || []).length;
      } else if (sortCol === 'insuranceCount') {
        va = (a.insurance || []).length;
        vb = (b.insurance || []).length;
      } else {
        va = a[sortCol];
        vb = b[sortCol];
      }
      if (typeof va === 'string') va = va.toLowerCase();
      if (typeof vb === 'string') vb = vb.toLowerCase();
      if (typeof va === 'boolean') { va = va ? 1 : 0; vb = vb ? 1 : 0; }
      if (va < vb) return -1 * sortDir;
      if (va > vb) return 1 * sortDir;
      return 0;
    });

    const tbody = document.getElementById('table-body');
    tbody.innerHTML = '';
    filtered.forEach(t => {
      const specCount = (t.specialties || []).length + (t.moreSpecialties || []).length;
      const insCount = (t.insurance || []).length;
      const topSpecs = (t.specialties || []).slice(0, 3).map(s => '<span class="tag">' + s + '</span>').join('');
      const tr = document.createElement('tr');
      tr.innerHTML = '<td><a href="provider.html?id=' + t.id + '" class="table-link">' + t.name + '</a></td>'
        + '<td>' + shortLicense(t.licenseType) + '</td>'
        + '<td>' + (t.licensedIn || t.location || '') + '</td>'
        + '<td>' + (t.yearsOfExperience || '—') + ' yrs</td>'
        + '<td>' + topSpecs + (specCount > 3 ? ' <span class="tag">+' + (specCount - 3) + '</span>' : '') + '</td>'
        + '<td>' + insCount + ' plans</td>'
        + '<td>' + (t.virtual ? 'Yes' : 'No') + '</td>'
        + '<td>' + (t.freeConsultation ? 'Yes' : '—') + '</td>';
      tbody.appendChild(tr);
    });
    document.getElementById('table-count').textContent = 'Showing ' + filtered.length + ' of ' + totalTherapists + ' therapists';
  }

  // Sort handler
  document.querySelectorAll('.data-table th[data-sort]').forEach(th => {
    th.addEventListener('click', () => {
      const col = th.dataset.sort;
      if (sortCol === col) sortDir *= -1;
      else { sortCol = col; sortDir = 1; }
      document.querySelectorAll('.data-table th').forEach(h => h.classList.remove('sorted'));
      th.classList.add('sorted');
      th.querySelector('.sort-arrow').textContent = sortDir === 1 ? '\u25B2' : '\u25BC';
      renderTable();
    });
  });

  // Filter handlers
  document.getElementById('table-search').addEventListener('input', renderTable);
  licenseSelect.addEventListener('change', renderTable);
  stateSelect.addEventListener('change', renderTable);
  renderTable();

  // ===== TABS =====
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
    });
  });
})();
</script>
</body>
</html>
